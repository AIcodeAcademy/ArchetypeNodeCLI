# Task 13 for Plan c1-f3

Create log middleware for command execution

**Layer**: application  
**Status**: not-started

### Reference

- [Feature Blueprint](/docs/f3-logging.blueprint.md)
- [Implementation Plan](/containers/c1-node-cli/docs/f3-logging.plan.md)
- [Language coding rules](/containers/c1-node-cli/.ai/rules/0-typescript.rules.md)  
- [Node CLI rules](/containers/c1-node-cli/.ai/rules/1-node-cli.rules.md)
- [Application Layer rules](/containers/c1-node-cli/.ai/rules/4-application-layer.rules.md)

## Instructions

- `src/app/command/commandTypes.ts` : Define command middleware types
  - Add middleware types to existing command system
  - Define a type `CommandHandler` representing a function that executes a command
  - Create a type `CommandMiddleware` representing a function that wraps a command handler

- `src/app/logger/commandLogger.middleware.ts` : Implement command logging middleware
  - Create a function `createCommandLoggerMiddleware(logger: LoggerService): CommandMiddleware`
  - Implement logging of command execution start
  - Add logging of command execution completion
  - Create logging for command execution errors
  - Implement a function `serializeCommand(command: unknown): object` to prepare commands for logging
  - Create a function `filterSensitiveData(data: unknown): unknown` to remove sensitive information

- `src/app/logger/performanceLogger.middleware.ts` : Implement performance monitoring
  - Create a function `createPerformanceLoggerMiddleware(logger: LoggerService): CommandMiddleware`
  - Implement timing of command execution
  - Create tracking of memory usage
  - Add logging of performance metrics
  - Implement threshold-based warnings for slow commands

- `src/app/logger/errorBoundary.middleware.ts` : Implement error handling middleware
  - Create a function `createErrorBoundaryMiddleware(logger: LoggerService): CommandMiddleware`
  - Implement try-catch wrapper for commands
  - Add detailed error logging with context
  - Create proper error translation for user-friendly messages
  - Implement a function `isUserError(error: unknown): boolean` to distinguish user vs system errors

- `src/app/command/middleware.ts` : Set up middleware system
  - Create a function `applyMiddleware(handler: CommandHandler, ...middlewares: CommandMiddleware[]): CommandHandler`
  - Implement middleware composition
  - Add proper middleware execution order
  - Create helper functions for common middleware combinations

- `src/app/index.ts` : Update command registration
  - Apply logging middleware to all commands
  - Configure error boundary for commands
  - Set up performance logging

> End of programming instructions for task 13. 