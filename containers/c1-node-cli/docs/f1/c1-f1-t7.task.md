# Task 7 for Plan c1-node-cli-f1-project-structure

Set up command entry points and execution flow for the Node CLI tool.

**Layer**: application  
**Status**: prompted

### Reference

- [Feature Blueprint](/docs/f1-project-structure.blueprint.md)
- [Implementation Plan](/containers/c1-node-cli/docs/f1/f1-project-structure.plan.md)
- [TypeScript rules](/containers/c1-node-cli/.ai/rules/0-typescript.rules.md)  
- [Node CLI rules](/containers/c1-node-cli/.ai/rules/1-node-cli.rules.md)
- [Application Layer rules](/containers/c1-node-cli/.ai/rules/4-application-layer.rules.md)

## Instructions

### Create main entry point

`/containers/c1-node-cli/src/index.ts`:
- Create main entry point:
  ```typescript
  import { program } from 'commander';
  import { ErrorHandler } from './domain/errors/handler';
  import { LoggingUtils } from './domain/utils/logging';

  async function main() {
    try {
      program
        .name('archetype-node-cli')
        .description('A CLI tool for managing archetypes')
        .version('1.0.0');

      // Import and register commands
      await import('./application/commands/container');
      await import('./application/commands/feature');
      await import('./application/commands/plan');

      await program.parseAsync(process.argv);
    } catch (error) {
      ErrorHandler.handle(error);
    }
  }

  main().catch(ErrorHandler.handle);
  ```

### Create command base class

`/containers/c1-node-cli/src/application/commands/base.ts`:
- Create CommandBase class:
  ```typescript
  import { Command } from 'commander';
  import { ErrorHandler } from '../../domain/errors/handler';
  import { LoggingUtils } from '../../domain/utils/logging';

  export abstract class CommandBase {
    protected program: Command;

    constructor(program: Command) {
      this.program = program;
    }

    protected async execute<T>(operation: () => Promise<T>): Promise<T> {
      try {
        return await operation();
      } catch (error) {
        ErrorHandler.handle(error);
        throw error; // This line will never be reached due to process.exit in handle
      }
    }

    protected logInfo(message: string, meta?: Record<string, unknown>): void {
      LoggingUtils.info(message, meta);
    }

    protected logError(message: string, meta?: Record<string, unknown>): void {
      LoggingUtils.error(message, meta);
    }

    public abstract register(): void;
  }
  ```

### Create container commands

`/containers/c1-node-cli/src/application/commands/container.ts`:
- Create ContainerCommands class:
  ```typescript
  import { program } from 'commander';
  import { CommandBase } from './base';
  import { ContainerRepository } from '../../domain/interfaces';

  export class ContainerCommands extends CommandBase {
    constructor(
      program: Command,
      private readonly containerRepository: ContainerRepository
    ) {
      super(program);
    }

    public register(): void {
      this.program
        .command('container')
        .description('Manage containers')
        .addCommand(
          new Command('list')
            .description('List all containers')
            .action(() => this.execute(() => this.listContainers()))
        )
        .addCommand(
          new Command('create')
            .description('Create a new container')
            .requiredOption('-n, --name <name>', 'Container name')
            .requiredOption('-l, --language <language>', 'Container language')
            .requiredOption('-a, --archetype <archetype>', 'Container archetype')
            .action((options) => this.execute(() => this.createContainer(options)))
        );
    }

    private async listContainers(): Promise<void> {
      const containers = await this.containerRepository.listContainers();
      this.logInfo('Containers:', { containers });
    }

    private async createContainer(options: {
      name: string;
      language: string;
      archetype: string;
    }): Promise<void> {
      // Implementation
    }
  }
  ```

### Create feature commands

`/containers/c1-node-cli/src/application/commands/feature.ts`:
- Create FeatureCommands class:
  ```typescript
  import { program } from 'commander';
  import { CommandBase } from './base';
  import { FeatureRepository } from '../../domain/interfaces';

  export class FeatureCommands extends CommandBase {
    constructor(
      program: Command,
      private readonly featureRepository: FeatureRepository
    ) {
      super(program);
    }

    public register(): void {
      this.program
        .command('feature')
        .description('Manage features')
        .addCommand(
          new Command('list')
            .description('List all features')
            .action(() => this.execute(() => this.listFeatures()))
        )
        .addCommand(
          new Command('create')
            .description('Create a new feature')
            .requiredOption('-n, --name <name>', 'Feature name')
            .requiredOption('-d, --description <description>', 'Feature description')
            .action((options) => this.execute(() => this.createFeature(options)))
        );
    }

    private async listFeatures(): Promise<void> {
      const features = await this.featureRepository.listFeatures();
      this.logInfo('Features:', { features });
    }

    private async createFeature(options: {
      name: string;
      description: string;
    }): Promise<void> {
      // Implementation
    }
  }
  ```

### Create plan commands

`/containers/c1-node-cli/src/application/commands/plan.ts`:
- Create PlanCommands class:
  ```typescript
  import { program } from 'commander';
  import { CommandBase } from './base';
  import { PlanRepository } from '../../domain/interfaces';

  export class PlanCommands extends CommandBase {
    constructor(
      program: Command,
      private readonly planRepository: PlanRepository
    ) {
      super(program);
    }

    public register(): void {
      this.program
        .command('plan')
        .description('Manage implementation plans')
        .addCommand(
          new Command('list')
            .description('List all plans')
            .action(() => this.execute(() => this.listPlans()))
        )
        .addCommand(
          new Command('create')
            .description('Create a new plan')
            .requiredOption('-f, --feature <feature>', 'Feature ID')
            .requiredOption('-c, --container <container>', 'Container slug')
            .action((options) => this.execute(() => this.createPlan(options)))
        );
    }

    private async listPlans(): Promise<void> {
      const plans = await this.planRepository.listPlans();
      this.logInfo('Plans:', { plans });
    }

    private async createPlan(options: {
      feature: string;
      container: string;
    }): Promise<void> {
      // Implementation
    }
  }
  ```

> End of programming instructions for task `c1-f1-t7`. 