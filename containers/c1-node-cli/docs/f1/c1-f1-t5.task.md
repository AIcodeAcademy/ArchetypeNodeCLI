# Task 5 for Plan c1-node-cli-f1-project-structure

Establish a comprehensive error handling structure for the Node CLI tool.

**Layer**: domain  
**Status**: prompted

### Reference

- [Feature Blueprint](/docs/f1-project-structure.blueprint.md)
- [Implementation Plan](/containers/c1-node-cli/docs/f1/f1-project-structure.plan.md)
- [TypeScript rules](/containers/c1-node-cli/.ai/rules/0-typescript.rules.md)  
- [Node CLI rules](/containers/c1-node-cli/.ai/rules/1-node-cli.rules.md)
- [Domain Layer rules](/containers/c1-node-cli/.ai/rules/3-domain-layer.rules.md)

## Instructions

### Create error types

`/containers/c1-node-cli/src/domain/errors/types.ts`:
- Create ErrorType enum:
  ```typescript
  export enum ErrorType {
    VALIDATION = 'VALIDATION',
    NOT_FOUND = 'NOT_FOUND',
    CONFLICT = 'CONFLICT',
    UNAUTHORIZED = 'UNAUTHORIZED',
    FORBIDDEN = 'FORBIDDEN',
    INTERNAL = 'INTERNAL'
  }
  ```

- Create ErrorDetails interface:
  ```typescript
  export interface ErrorDetails {
    code: string;
    message: string;
    type: ErrorType;
    context?: Record<string, unknown>;
  }
  ```

### Create base error classes

`/containers/c1-node-cli/src/domain/errors/base.ts`:
- Create BaseError class:
  ```typescript
  export abstract class BaseError extends Error {
    public readonly details: ErrorDetails;
    public readonly timestamp: Date;

    constructor(details: ErrorDetails) {
      super(details.message);
      this.name = this.constructor.name;
      this.details = details;
      this.timestamp = new Date();
      Error.captureStackTrace(this, this.constructor);
    }

    public toJSON(): Record<string, unknown> {
      return {
        name: this.name,
        message: this.message,
        details: this.details,
        timestamp: this.timestamp.toISOString(),
        stack: this.stack
      };
    }
  }
  ```

### Create specific error classes

`/containers/c1-node-cli/src/domain/errors/specific.ts`:
- Create ValidationError:
  ```typescript
  export class ValidationError extends BaseError {
    constructor(message: string, context?: Record<string, unknown>) {
      super({
        code: 'VALIDATION_ERROR',
        message,
        type: ErrorType.VALIDATION,
        context
      });
    }
  }
  ```

- Create NotFoundError:
  ```typescript
  export class NotFoundError extends BaseError {
    constructor(resource: string, id: string) {
      super({
        code: 'NOT_FOUND_ERROR',
        message: `${resource} with id '${id}' not found`,
        type: ErrorType.NOT_FOUND,
        context: { resource, id }
      });
    }
  }
  ```

- Create ConflictError:
  ```typescript
  export class ConflictError extends BaseError {
    constructor(message: string, context?: Record<string, unknown>) {
      super({
        code: 'CONFLICT_ERROR',
        message,
        type: ErrorType.CONFLICT,
        context
      });
    }
  }
  ```

### Create error factory

`/containers/c1-node-cli/src/domain/errors/factory.ts`:
- Create ErrorFactory class:
  ```typescript
  export class ErrorFactory {
    public static createValidationError(message: string, context?: Record<string, unknown>): ValidationError {
      return new ValidationError(message, context);
    }

    public static createNotFoundError(resource: string, id: string): NotFoundError {
      return new NotFoundError(resource, id);
    }

    public static createConflictError(message: string, context?: Record<string, unknown>): ConflictError {
      return new ConflictError(message, context);
    }
  }
  ```

### Create error handler

`/containers/c1-node-cli/src/domain/errors/handler.ts`:
- Create ErrorHandler class:
  ```typescript
  export class ErrorHandler {
    public static handle(error: unknown): void {
      if (error instanceof BaseError) {
        console.error(JSON.stringify(error.toJSON(), null, 2));
        process.exit(1);
      } else if (error instanceof Error) {
        console.error({
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        process.exit(1);
      } else {
        console.error('An unknown error occurred:', error);
        process.exit(1);
      }
    }
  }
  ```

### Create error middleware

`/containers/c1-node-cli/src/domain/errors/middleware.ts`:
- Create ErrorMiddleware class:
  ```typescript
  export class ErrorMiddleware {
    public static async handleAsync<T>(operation: () => Promise<T>): Promise<T> {
      try {
        return await operation();
      } catch (error) {
        ErrorHandler.handle(error);
        throw error; // This line will never be reached due to process.exit in handle
      }
    }
  }
  ```

> End of programming instructions for task `c1-f1-t5`. 